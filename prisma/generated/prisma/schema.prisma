generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model users {
  user_id      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone_number String    @unique @db.VarChar(20)
  created_at   DateTime? @default(now()) @db.Timestamp(6)

  conversation conversations?
  messages     messages[]
}

model conversations {
  conversation_id String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String    @unique @db.Uuid // <-- enforces 1 conversation per user
  is_open         Boolean?  @default(true)
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  updated_at      DateTime? @updatedAt @db.Timestamp(6)

  user     users      @relation(fields: [user_id], references: [user_id])
  messages messages[]
}

model messages {
  message_id         BigInt    @id @default(autoincrement())
  conversation_id    String    @db.Uuid
  user_id            String?   @db.Uuid
  direction          String?   @db.VarChar(10) // "inbound" | "outbound"
  message_text       String?
  message_status     String?   @db.VarChar(30)
  twilio_message_sid String?   @unique @db.VarChar(100)
  created_at         DateTime? @default(now()) @db.Timestamp(6)

  conversation conversations @relation(fields: [conversation_id], references: [conversation_id])
  user         users?        @relation(fields: [user_id], references: [user_id])

  @@index([twilio_message_sid])
  @@index([conversation_id])
}
